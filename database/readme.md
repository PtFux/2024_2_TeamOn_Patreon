### Безопасность
#### **Роли**
У всех должны быть права на:
- Подключение к pushart
- CRUD таблиц в пушарт кроме People
- Select People кроме People.hash_password

| **Роль** | **Тип роли** | **суперюзер** |  C.UD People |  Select People.**hash_password** | 
|----|----|----|----|---|
| __admin__ | роль | __+__ | __+__ | __+__ |
| **backend** | группа |  __-__ | __-__ | __-__ |
| **auth_service** | роль, наследует права от __backend__ + доп. права |  __-__ | __+__ | __+__ |
| **author_service** | роль, наследует права от __backend__ + доп права |  __+__ | __-__ | __-__ |
| **account_service** | роль, наследует права от __backend__ + доп права |  __+__ | __-__ | __-__ |
| **content_service** | роль, наследует права от __backend__ |  __-__ | __-__ | __-__ |
| **moderation_service** | роль, наследует права от __backend__ |  __-__ | __-__ | __-__ |
| **custom_subscription_service** | роль, наследует права от __backend__ |  __-__ | __-__ | __-__ |

- Права отбираются у всех в миграции - `100_revoke_all.up.sql`.
- Создается базовая роль __backend__ - `101_create_backend_role.up.sql`
- Создаются остальные роли со специфичными правами - `102_create_service_roles.up.sql`

Каждому сервису выдается роль пользователя в соответствующем ему env файл. 
Все конфиги лежат по пути - `config/*service_name*`

#### SQL-injections
Защита от sql-инъекций осуществляется за счет использования параметризованных запросов с помощью библиотеки pgx.

### Конфигурация
Файл конфигурации postgresql лежит [`config/postgres/postgres.conf`](../config/postgres/postgres.conf)
Подключается командой в docker-compose при запуске postgres

Пояснения выбора некоторых параметров:
- `listen_addresses = '*'`  
Postgresql находится в одной сети monitoring со всеми микросервисами. IP-адреса раздаются динамически, поэтому необходимо 
чтобы postgres слушал все адреса. Это также будет безопасно, потому что помимо микросервисов, подключитсья к postgresql можно будет только с localhost
- `max_connections = 50`  
Рассуждения были следующие:  
Характеристики сервака:
  - Количество ядер: 1
  - Количество поток ядра: 1
  - Оперативная память: 4гб
  
  Количество сервисов: 7  
  pull_max_connection: 4 - характеристика пулла коннектионов в каждом сервисе  
  Возьмем немного с запасом - 4 * 10 = 40

- `statement_timeout` = 10000 # (ms) // 10 секунд   
	Устанавливает максимально допустимую длительность любого оператора  
Прервать любой оператор, который занимает больше указанного времени.  
Дольше 10 секунд никто ждать не будет
- `lock_timeout` = 5000 # (ms) // 30 секунд   
Устанавливает максимально допустимую продолжительность ожидания блокировки. 
Прервать любой оператор, который ждет дольше указанного времени при попытке получить блокировку таблицы, индекса, строки или другого объекта базы данных.

- `log_min_duration_statement` = 50 # (ms) регаем все что дольше 50 мс
- `log_destination` = 'csvlog' # для пгдибир   
Формат csv парсится pgbadger’ом
- `pg_stat_statements.max` = 5000   # место на сервере мало
- `pg_stat_statements.track` = top  # нужны только параметры непосредственно вызываемые клиентами
- `pg_stat_statements.save` = on # у нас сервер будет часто перезагружаться, статистику можно оставлять
